## 동시성 이슈 및 DB Lock

### 동시성 문제가 발생하는 원인

  * 현재 대부분의 어플리케이션이 멀티 스레드 기반으로 설계되어 여러 요청을 병렬로 처리하는데,
    동시에 여러 스레드가 요청을 처리하다보면 요청이 들어온 순서와 실제로 처리되는 순서가 달라질 수 있음.
    
    1. 스레드 지연 등으로 작업 순서가 보장 되지 않음.
    2. 네크워크에 영향을 받을 수 있음. 먼저 도착한 요청이 있더라도 네트워크 지연으로 인해 뒤에 들어온 요청이 먼저 처리될 수 있음.
    3. 두 요청이 거의 동시에 조건을 확인하고 작업을 수행하려고 할 때, 조건 확인 이후의 상태 변화는 감지하지 못하여 문제가 발생할 수 있음. 

### DB Lock 

  1) 낙관적 락
     - 데이터 정합성이 중요하고 요청 순서는 덜 중요한 경우 사용
     - 상태 변화가 생겼는지 확인하기 위해 버전 번호 사용 (@version)
     
    * 장점 : 충돌이 적은 환경에서 성능 향상
    * 단점 : 충돌이 빈번하면 재시도 비용 up, 충돌 발생 시 재시도 로직 필요
  
  2) 비관적 락
     - 트랜잭션 동안 리소스 잠금 -> 동시 수정을 방지함.

    * 장점 : 데이터 충돌을 사전에 방지할 수 있음.
    * 단점 : 성능이 저하될 수 있고 교착상태(데드락)에 빠질 위험이 있음.
    
### 문제 상황
   
  * 선착순 쿠폰 발급 
    - 중복 발급
    - 발급 가능 수량 초과
      
  * 재고 차감
    - 다수의 사용자가 동일한 상품을 구매할 때의 재고 관리

### 문제 상황 별 해결
  #### * 비관 락 사용
      - 요청 순서가 매우 중요하고 충돌이 많을 것이라고 예상되는 상황
      
      1) 선착순 쿠폰 발급
        - 발급 가능한 쿠폰의 최대 수량을 초과하지 않도록 트랜잭션 동안 리소스를 잠가야 함.
        
      2) 재고 차감
        - 선착순 쿠폰 발급과 마찬가지로 특정 시간대에 특가로 구매가능한 상품의 경우.

  #### * 낙관 락 사용
      1) 재고 차감 
        - 상품 재고가 많고 주문이 일시적으로 몰리지 않는,
        - 요청 시도의 충돌 가능성이 적은 안정적인 트랜잭션이 발생하는 상품의 경우.
        
